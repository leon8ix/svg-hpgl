{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { parsePath, PathInstruction } from './svg-path';\r\nimport getBezierPoints from 'adaptive-bezier-curve';\r\n\r\nexport type HPGLCommand = 'PU' | 'PD' | 'PA' | `SP${number}`;\r\nexport type HPGLInstruction = [HPGLCommand, ...number[]];\r\nexport type HPGLProgram = HPGLInstruction[];\r\n\r\nexport function buildHPGL(program: HPGLProgram, prefix = '', suffix = ''): string {\r\n\treturn prefix + program.map(([cmd, ...vals]) => cmd + vals.join(',') + ';').join('') + suffix;\r\n}\r\n\r\n/** defaults to any stroked element, uses selector in this prio: selector > stroke > `[stroke]` */\r\nexport type PenSelectors = {\r\n\tpen: number;\r\n\t/** [stroke], [stroke=magenta] or any other querySelector */\r\n\tselector?: string;\r\n\t/** should use values retrieved by getSvgStrokeColors */\r\n\tstroke?: string | string[];\r\n\t/** Gets inserted after `SP1` (select pen x) and before any commands with that tool */\r\n\tcmd?: string;\r\n}[];\r\n\r\nexport type SVGtoHPGLOptions = {\r\n\t/** Number of line segments per og unit any curves will be split into */\r\n\tsegmentsPerUnit?: number;\r\n\t/** 1. Rotation (degrees, clockwise, around center of svg) */\r\n\trotation?: number;\r\n\t/** 2. Offset (og unit, before rotation) */\r\n\toffsetX?: number;\r\n\t/** 2. Offset (og unit, before rotation) */\r\n\toffsetY?: number;\r\n\t/** 3. Scale (factor used in hpgl values) */\r\n\tscale?: number;\r\n};\r\n\r\nexport function svgToHPGL(\r\n\tsvg: SVGSVGElement,\r\n\tpens: PenSelectors = [{ pen: 1 }],\r\n\toptions: SVGtoHPGLOptions = {}\r\n): HPGLProgram {\r\n\tconst hpgl: HPGLProgram = [['PA']];\r\n\tconst { segmentsPerUnit = 1 } = options;\r\n\r\n\tpens.forEach(({ pen, selector, stroke, cmd: penCmd }) => {\r\n\t\tlet sel = selector;\r\n\t\tif (Array.isArray(stroke)) sel ??= stroke.map(s => `[stroke=\"${s}\"]`).join(',');\r\n\t\tif (stroke) sel ??= `[stroke=\"${stroke}\"]`;\r\n\t\tsel ??= '[stroke]';\r\n\t\tconst elements = svg.querySelectorAll(sel);\r\n\t\tif (!elements.length) return;\r\n\r\n\t\thpgl.push([`SP${pen}`], ['PU']);\r\n\t\tif (penCmd) hpgl.push([penCmd as HPGLCommand]);\r\n\r\n\t\telements.forEach(el => {\r\n\t\t\tif (!(el instanceof SVGGraphicsElement)) return;\r\n\t\t\tconst tf = getTransformer(el, options);\r\n\r\n\t\t\tif (el instanceof SVGLineElement) {\r\n\t\t\t\t// <line>\r\n\t\t\t\thpgl.push(PU(tf, svgVal(el.x1), svgVal(el.y1)));\r\n\t\t\t\thpgl.push(PD(tf, svgVal(el.x2), svgVal(el.y2)));\r\n\t\t\t\treturn;\r\n\t\t\t} else if (el instanceof SVGPolylineElement) {\r\n\t\t\t\t// <polyline>\r\n\t\t\t\tconst points = el.points;\r\n\t\t\t\tif (points[0]) hpgl.push(PU(tf, points[0]?.x, points[0]?.y));\r\n\t\t\t\tfor (const pt of points) hpgl.push(PD(tf, pt.x, pt.y));\r\n\t\t\t\treturn;\r\n\t\t\t} else if (el instanceof SVGCircleElement) {\r\n\t\t\t\t// <circle>\r\n\t\t\t\tconst { cx, cy, r } = svgVals(el, ['cx', 'cy', 'r']);\r\n\t\t\t\tconst circum = 2 * Math.PI * r;\r\n\t\t\t\tconst segments = circum * segmentsPerUnit;\r\n\t\t\t\thpgl.push(PU(tf, cx + r, cy));\r\n\t\t\t\thpgl.push(...getArcPoints(cx, cy, r, r, 0, 2 * Math.PI, segments).map(pt => PD(tf, ...pt)));\r\n\t\t\t\treturn;\r\n\t\t\t} else if (el instanceof SVGEllipseElement) {\r\n\t\t\t\t// <ellipse>\r\n\t\t\t\tconst { cx, cy, rx, ry } = svgVals(el, ['cx', 'cy', 'rx', 'ry']);\r\n\t\t\t\tconst circum = Math.PI * (rx + ry); // approx.\r\n\t\t\t\tconst segments = circum * segmentsPerUnit;\r\n\t\t\t\thpgl.push(PU(tf, cx + rx, cy));\r\n\t\t\t\thpgl.push(...getArcPoints(cx, cy, rx, ry, 0, 2 * Math.PI, segments).map(pt => PD(tf, ...pt)));\r\n\t\t\t\treturn;\r\n\t\t\t} else if (el instanceof SVGRectElement) {\r\n\t\t\t\t// <rect>\r\n\t\t\t\tconst { width: w, height: h, x, y } = svgVals(el, ['width', 'height', 'x', 'y']);\r\n\t\t\t\tconst rx = Math.min(w / 2, svgVal(el.rx) || svgVal(el.ry) || 0);\r\n\t\t\t\tconst ry = Math.min(h / 2, svgVal(el.ry) || svgVal(el.rx) || 0);\r\n\t\t\t\tif (!rx || !ry) {\r\n\t\t\t\t\thpgl.push(PU(tf, x, y));\r\n\t\t\t\t\thpgl.push(PD(tf, x + w, y));\r\n\t\t\t\t\thpgl.push(PD(tf, x + w, y + h));\r\n\t\t\t\t\thpgl.push(PD(tf, x, y + h));\r\n\t\t\t\t\thpgl.push(PD(tf, x, y));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst circum = 0.25 * Math.PI * (rx + ry); // approx.\r\n\t\t\t\t\tconst segments = circum * segmentsPerUnit;\r\n\t\t\t\t\thpgl.push(\r\n\t\t\t\t\t\t...PUD(tf, [\r\n\t\t\t\t\t\t\t...getArcPoints(x + rx, y + ry, rx, ry, Math.PI, 1.5 * Math.PI, segments),\r\n\t\t\t\t\t\t\t...getArcPoints(x + w - rx, y + ry, rx, ry, 1.5 * Math.PI, 2 * Math.PI, segments),\r\n\t\t\t\t\t\t\t...getArcPoints(x + w - rx, y + h - ry, rx, ry, 0, 0.5 * Math.PI, segments),\r\n\t\t\t\t\t\t\t...getArcPoints(x + rx, y + h - ry, rx, ry, 0.5 * Math.PI, Math.PI, segments),\r\n\t\t\t\t\t\t\t[x, y + ry],\r\n\t\t\t\t\t\t])\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t\treturn;\r\n\t\t\t} else if (el instanceof SVGPathElement) {\r\n\t\t\t\t// <path>\r\n\t\t\t\tconst d = el.getAttribute('d');\r\n\t\t\t\tif (!d) return;\r\n\t\t\t\tlet currX = 0;\r\n\t\t\t\tlet currY = 0;\r\n\t\t\t\tfunction updateCurr(ins: PathInstruction) {\r\n\t\t\t\t\tif ('x' in ins) currX = ins.x;\r\n\t\t\t\t\tif ('y' in ins) currY = ins.y;\r\n\t\t\t\t}\r\n\t\t\t\tconst instructions = parsePath(d);\r\n\t\t\t\t// console.log('Path', instructions);\r\n\t\t\t\tinstructions.forEach((ins, insI) => {\r\n\t\t\t\t\tconst { cmd } = ins;\r\n\t\t\t\t\tif (cmd === 'M') {\r\n\t\t\t\t\t\thpgl.push(PU(tf, ins.x, ins.y));\r\n\t\t\t\t\t} else if (cmd === 'L') {\r\n\t\t\t\t\t\thpgl.push(PD(tf, ins.x, ins.y));\r\n\t\t\t\t\t} else if (cmd === 'H') {\r\n\t\t\t\t\t\thpgl.push(PD(tf, ins.x, currY));\r\n\t\t\t\t\t} else if (cmd === 'V') {\r\n\t\t\t\t\t\thpgl.push(PD(tf, currX, ins.y));\r\n\t\t\t\t\t} else if (cmd === 'C') {\r\n\t\t\t\t\t\tconst points = getBezierPoints(\r\n\t\t\t\t\t\t\t[currX, currY],\r\n\t\t\t\t\t\t\t[ins.x1, ins.y1],\r\n\t\t\t\t\t\t\t[ins.x2, ins.y2],\r\n\t\t\t\t\t\t\t[ins.x, ins.y],\r\n\t\t\t\t\t\t\t10\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\thpgl.push(...PUD(tf, points));\r\n\t\t\t\t\t} else if (cmd === 'S') {\r\n\t\t\t\t\t\t// If the previous command was cubic BÃ©zier (C or S): Reflect the second control point.\r\n\t\t\t\t\t\t// If the previous command was anything else: Treat the first control point as the current point.\r\n\t\t\t\t\t\tconst preCmd = instructions[insI - 1];\r\n\t\t\t\t\t\tconst preHasC2 = preCmd && 'x2' in preCmd && 'y2' in preCmd;\r\n\t\t\t\t\t\tconst x1 = preHasC2 ? 2 * currX - preCmd.x2 : currX;\r\n\t\t\t\t\t\tconst y1 = preHasC2 ? 2 * currY - preCmd.y2 : currY;\r\n\t\t\t\t\t\tconst points = getBezierPoints([currX, currY], [x1, y1], [ins.x2, ins.y2], [ins.x, ins.y], 10);\r\n\t\t\t\t\t\thpgl.push(...PUD(tf, points));\r\n\t\t\t\t\t\tupdateCurr(ins);\r\n\t\t\t\t\t} else if (cmd === 'Q') {\r\n\t\t\t\t\t\t// TODO\r\n\t\t\t\t\t} else if (cmd === 'T') {\r\n\t\t\t\t\t\t// TODO\r\n\t\t\t\t\t} else if (cmd === 'A') {\r\n\t\t\t\t\t\t// TODO\r\n\t\t\t\t\t} else if (cmd === 'Z') {\r\n\t\t\t\t\t\tconst firstIns = instructions[0];\r\n\t\t\t\t\t\tconst firstX = firstIns?.cmd === 'M' ? firstIns.x : 0;\r\n\t\t\t\t\t\tconst firstY = firstIns?.cmd === 'M' ? firstIns.y : 0;\r\n\t\t\t\t\t\thpgl.push(PD(tf, firstX, firstY));\r\n\t\t\t\t\t}\r\n\t\t\t\t\tupdateCurr(ins);\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n\r\n\treturn hpgl;\r\n}\r\n\r\nfunction getTransformer(\r\n\telement: SVGGraphicsElement,\r\n\t{ offsetX = 0, offsetY = 0, rotation = 0, scale = 1 }: SVGtoHPGLOptions\r\n): (x: number, y: number) => [number, number] {\r\n\tconst rootSVG = getRootSVG(element);\r\n\r\n\tif (!rootSVG) {\r\n\t\tconsole.warn('Could not retrieve ownerSVGElement');\r\n\t\treturn (x: number, y: number) => [Math.round(x), Math.round(y)];\r\n\t}\r\n\tconst familyTree = getSVGFamilyTree(element);\r\n\t// console.log('getTransformer', familyTree);\r\n\r\n\tlet ctm = rootSVG.createSVGMatrix();\r\n\tlet elCTM: DOMMatrix | undefined;\r\n\r\n\tfor (const el of familyTree) {\r\n\t\tif (el instanceof SVGSVGElement) {\r\n\t\t\t// console.log('SVGSVGElement');\r\n\t\t\telCTM = getSVGSVGElementTransform(el);\r\n\t\t} else if (el instanceof SVGGraphicsElement) {\r\n\t\t\t// console.log('SVGGraphicsElement');\r\n\t\t\telCTM = el.transform.baseVal.consolidate()?.matrix;\r\n\t\t} else {\r\n\t\t\telCTM = undefined;\r\n\t\t}\r\n\t\t// console.log({ elCTM, el });\r\n\t\tif (elCTM) ctm = elCTM.multiply(ctm);\r\n\t}\r\n\r\n\t// Merge in manually specified transformations\r\n\tconst userCTM = rootSVG.createSVGMatrix().translate(offsetX, offsetY).rotate(rotation).scale(scale);\r\n\tctm = userCTM.multiply(ctm);\r\n\r\n\tconst point = rootSVG.createSVGPoint();\r\n\t// Return a transformed coordinate function\r\n\treturn (x: number, y: number) => {\r\n\t\tpoint.x = x;\r\n\t\tpoint.y = y;\r\n\t\tconst transformedPoint = point.matrixTransform(ctm);\r\n\t\treturn [Math.round(transformedPoint.x), Math.round(transformedPoint.y)];\r\n\t};\r\n}\r\n\r\nfunction getSVGSVGElementTransform(currSVG: SVGSVGElement) {\r\n\tconst rootSVG = currSVG.ownerSVGElement || currSVG;\r\n\tconst pos = {\r\n\t\tx: svgVal(currSVG.x),\r\n\t\ty: svgVal(currSVG.y),\r\n\t\tw: svgVal(currSVG.width) || rootSVG.viewBox.baseVal.width,\r\n\t\th: svgVal(currSVG.height) || rootSVG.viewBox.baseVal.height,\r\n\t};\r\n\tconst view = {\r\n\t\tx: currSVG.viewBox.baseVal.x || 0,\r\n\t\ty: currSVG.viewBox.baseVal.y || 0,\r\n\t\tw: currSVG.viewBox.baseVal.width || pos.w,\r\n\t\th: currSVG.viewBox.baseVal.height || pos.h,\r\n\t};\r\n\r\n\t// Handle preserveAspectRatio alignment\r\n\tconst preserveAspectRatio = currSVG.preserveAspectRatio.baseVal;\r\n\tconst align = preserveAspectRatio.align;\r\n\tconst meetOrSlice = preserveAspectRatio.meetOrSlice;\r\n\r\n\t// align === SVGPreserveAspectRatio.SVG_PRESERVEASPECTRATIO_NONE\r\n\tlet scaleX = pos.w / view.w;\r\n\tlet scaleY = pos.h / view.h;\r\n\tlet translateX = pos.x - view.x;\r\n\tlet translateY = pos.y - view.y;\r\n\t// console.log('align', SVGPreserveAspectRatio.SVG_PRESERVEASPECTRATIO_NONE === align, align, scaleX, scaleY);\r\n\r\n\tif (align !== SVGPreserveAspectRatio.SVG_PRESERVEASPECTRATIO_NONE) {\r\n\t\tif (meetOrSlice === SVGPreserveAspectRatio.SVG_MEETORSLICE_SLICE) {\r\n\t\t\tscaleX = scaleY = Math.max(scaleX, scaleY); // slice / fill\r\n\t\t} else {\r\n\t\t\tscaleX = scaleY = Math.min(scaleX, scaleY); // meet / contain / default\r\n\t\t}\r\n\r\n\t\t// Apply alignment adjustments\r\n\t\tconst alignX = align % 3; // xMin(1), xMid(2), xMax(3)\r\n\t\tconst alignY = Math.floor(align / 3); // yMin(1), yMid(2), yMax(3)\r\n\r\n\t\tif (alignX === 2) translateX += (pos.w - view.w * scaleX) / 2; // xMid\r\n\t\tif (alignX === 3) translateX += pos.w - view.w * scaleX; // xMax\r\n\r\n\t\tif (alignY === 2) translateY += (pos.h - view.h * scaleY) / 2; // yMid\r\n\t\tif (alignY === 3) translateY += pos.h - view.h * scaleY; // yMax\r\n\t}\r\n\t// console.log('Handling SVG scaling', { currSVG, translateX, translateY, scaleX, scaleY });\r\n\r\n\t// Account for <svg> x, y offset, and scale to viewBox with adjusted origin\r\n\treturn rootSVG.createSVGMatrix().translate(translateX, translateY).scale(scaleX, scaleY);\r\n}\r\n\r\n/** Finds the root SVGSVGElement, even for nested SVGs */\r\nfunction getRootSVG(element: SVGGraphicsElement): SVGSVGElement | null {\r\n\tlet svg = element.ownerSVGElement;\r\n\twhile (svg?.ownerSVGElement) svg = svg.ownerSVGElement;\r\n\treturn svg;\r\n}\r\n\r\n/** Retrieves the whole ancestry of SVGs as well as nested SVGs going from child to root SVG */\r\nfunction getSVGFamilyTree(element: SVGElement): SVGElement[] {\r\n\tconst tree: SVGElement[] = [];\r\n\tlet currEl: ParentNode | null = element;\r\n\twhile (currEl instanceof SVGElement) {\r\n\t\ttree.push(currEl);\r\n\t\tcurrEl = currEl.parentNode;\r\n\t}\r\n\treturn tree;\r\n}\r\n\r\nfunction svgVal(prop: SVGAnimatedLength) {\r\n\treturn prop.baseVal.value || 0;\r\n}\r\n\r\nfunction svgVals<T extends SVGGraphicsElement & Record<U, { baseVal: { value: number } }>, U extends keyof T>(\r\n\tel: T,\r\n\tprops: U[]\r\n) {\r\n\tconst vals = {} as Record<U, number>;\r\n\tfor (const prop of props) {\r\n\t\tif (!el[prop]?.baseVal) {\r\n\t\t\tconsole.warn(`Prop ${String(prop)} not in Element`, el);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\t\tvals[prop] = el[prop].baseVal.value || 0;\r\n\t}\r\n\treturn vals;\r\n}\r\n\r\nfunction getArcPoints(\r\n\tcx: number,\r\n\tcy: number,\r\n\trx: number,\r\n\try: number,\r\n\tstartAngle: number,\r\n\tendAngle: number,\r\n\t/** Will be rounded and changed to min of `2` */\r\n\tsegments: number\r\n) {\r\n\tsegments = Math.max(2, Math.round(segments));\r\n\tconst arcPoints: [number, number][] = [];\r\n\tfor (let i = 0; i <= segments; i++) {\r\n\t\tconst angle = startAngle + (i * (endAngle - startAngle)) / segments;\r\n\t\tarcPoints.push([cx + rx * Math.cos(angle), cy + ry * Math.sin(angle)]);\r\n\t}\r\n\treturn arcPoints;\r\n}\r\n\r\nfunction PU(tf: ReturnType<typeof getTransformer>, x: number, y: number): HPGLInstruction {\r\n\treturn ['PU', ...tf(x, y)];\r\n}\r\nfunction PD(tf: ReturnType<typeof getTransformer>, x: number, y: number): HPGLInstruction {\r\n\treturn ['PD', ...tf(x, y)];\r\n}\r\nfunction PUD(tf: ReturnType<typeof getTransformer>, points: [number, number][]): HPGLInstruction[] {\r\n\treturn points.map((pt, i) => (i === 0 ? PU(tf, ...pt) : PD(tf, ...pt)));\r\n}\r\n\r\n/** Implements and expects absolute coords (PA)  */\r\nexport function hpglFindBBox(hpgl: HPGLProgram) {\r\n\tconst cmds: HPGLCommand[] = ['PU', 'PD', 'PA'];\r\n\tlet xMin: number, xMax: number, yMin: number, yMax: number;\r\n\txMin = xMax = yMin = yMax = 0;\r\n\thpgl.forEach(([cmd, x, y, ...vals]) => {\r\n\t\tif (cmds.includes(cmd) && x && y && vals.length === 0) {\r\n\t\t\tif (x < xMin) xMin = x;\r\n\t\t\tif (x > xMax) xMax = x;\r\n\t\t\tif (y < yMin) yMin = y;\r\n\t\t\tif (y > yMax) yMax = y;\r\n\t\t}\r\n\t});\r\n\treturn { xMin, xMax, yMin, yMax, width: xMax - xMin, height: yMax - yMin };\r\n}\r\n\r\nexport function drawHPGL(canvas: HTMLCanvasElement, hpgl: HPGLProgram, width: number, height: number): void {\r\n\t// console.log(width, height);\r\n\tcanvas.width = width;\r\n\tcanvas.height = height;\r\n\tconst ctx = canvas.getContext('2d');\r\n\tif (!ctx) throw new Error('Context of canvas unavailable');\r\n\r\n\tctx.fillStyle = '#ffffff';\r\n\tctx.fillRect(0, 0, width, height);\r\n\r\n\tctx.lineWidth = Math.round(Math.max(width, height) / 1000);\r\n\tctx.strokeStyle = '#000000';\r\n\tctx.beginPath();\r\n\r\n\thpgl.forEach(([cmd, x, y, ...vals]) => {\r\n\t\t// console.log({ cmd, x, y, vals });\r\n\t\tif (x === undefined || y === undefined || vals.length) return;\r\n\t\tif (cmd === 'PU') {\r\n\t\t\tctx.moveTo(x, y);\r\n\t\t} else if (cmd === 'PD') {\r\n\t\t\tctx.lineTo(x, y);\r\n\t\t}\r\n\t});\r\n\r\n\tctx.stroke();\r\n}\r\n\r\nexport function getSVGStrokeColors(svg: SVGSVGElement): Set<string> {\r\n\tconst colors = new Set<string>();\r\n\r\n\tsvg.querySelectorAll('[stroke]').forEach(el => {\r\n\t\tconst stroke = el.getAttribute('stroke');\r\n\t\tif (stroke) colors.add(stroke);\r\n\t});\r\n\treturn colors;\r\n}\r\n"]}